# 微信小程序 - 门诊预约系统开发需求

请帮我开发一个完整的门诊预约微信小程序系统,包含小程序前端、后端 API 和后台管理系统。

## 一、项目概述

开发一个医院门诊预约系统,患者可以通过微信小程序预约挂号,医院管理人员可以通过后台管理系统管理预约、医生、排班等数据。

## 二、技术栈要求

- **小程序前端**: uni-app (微信小程序)
- **后端**: Go + Gin 框架 + GORM + MySQL
- **后台管理**: React + Ant Design (antd)
- **数据库**: MySQL 8.0+
- **认证**: JWT Token
- **API 文档**: Swagger 自动生成

## 三、功能模块详细需求

### 小程序端功能

#### 1. 用户模块

- 微信一键登录(获取用户 openid)
- 个人信息完善(姓名、手机号、身份证号)
- 就诊人管理(可添加多个就诊人,包括家人)
- 个人中心页面

#### 2. 预约挂号模块

- 科室列表展示(卡片式布局)
- 医生列表(显示医生头像、姓名、职称、擅长领域)
- 医生详情页(简介、出诊时间)
- 排班日历查询(显示未来 7 天可预约时段)
- 号源选择(上午/下午时段,具体时间点)
- 预约表单提交(选择就诊人、填写症状描述)

#### 3. 我的预约

- 预约列表(全部/待就诊/已完成/已取消,带状态标签)
- 预约详情查看
- 取消预约功能(带二次确认)
- 就诊提醒

#### 4. 就诊记录

- 历史就诊记录列表
- 就诊详情(诊断结果、处方等)

### 后端 API 接口

#### 用户相关

```
POST /api/user/login - 微信登录
GET /api/user/info - 获取用户信息
PUT /api/user/info - 更新用户信息
GET /api/user/patients - 获取就诊人列表
POST /api/user/patients - 添加就诊人
PUT /api/user/patients/:id - 编辑就诊人
DELETE /api/user/patients/:id - 删除就诊人
```

#### 预约相关

```
GET /api/departments - 获取科室列表
GET /api/doctors - 获取医生列表(支持按科室筛选)
GET /api/doctors/:id - 获取医生详情
GET /api/schedule - 查询医生排班(按医生ID和日期)
GET /api/schedule/available - 获取可预约时段
POST /api/appointments - 创建预约
GET /api/appointments - 获取我的预约列表
GET /api/appointments/:id - 获取预约详情
PUT /api/appointments/:id/cancel - 取消预约
```

#### 就诊记录

```
GET /api/records - 获取就诊记录列表
GET /api/records/:id - 获取就诊记录详情
```

#### 后台管理

```
POST /api/admin/login - 管理员登录
GET /api/admin/appointments - 预约列表(支持筛选、分页)
PUT /api/admin/appointments/:id - 更新预约状态
GET /api/admin/patients - 患者列表
GET /api/admin/departments - 科室管理
POST /api/admin/departments - 添加科室
PUT /api/admin/departments/:id - 编辑科室
DELETE /api/admin/departments/:id - 删除科室
GET /api/admin/doctors - 医生管理
POST /api/admin/doctors - 添加医生
PUT /api/admin/doctors/:id - 编辑医生
DELETE /api/admin/doctors/:id - 删除医生
GET /api/admin/schedules - 排班列表
POST /api/admin/schedules - 创建排班
PUT /api/admin/schedules/:id - 编辑排班
DELETE /api/admin/schedules/:id - 删除排班
GET /api/admin/statistics - 数据统计
```

### 后台管理系统功能

#### 1. 登录与权限

- 管理员登录页面
- 基于角色的权限控制

#### 2. 仪表盘

- 今日预约数量统计
- 待就诊/已完成/已取消统计卡片
- 近 7 天预约趋势图表
- 热门科室排行

#### 3. 预约管理

- 预约订单列表(表格展示,支持搜索、筛选、分页)
- 筛选条件: 状态、科室、医生、日期范围
- 预约详情查看(抽屉或弹窗)
- 手动取消预约
- 导出预约数据(Excel)

#### 4. 患者管理

- 患者信息列表
- 患者详细档案查看
- 就诊历史记录

#### 5. 医院数据管理

- **科室管理**: 列表、添加、编辑、删除
- **医生管理**: 列表、添加、编辑、删除、上传头像
- **排班管理**: 日历视图、按医生设置排班、批量排班功能

#### 6. 数据统计

- 预约量统计(折线图)
- 科室就诊量分布(饼图)
- 医生工作量统计(柱状图)
- 取消率分析

## 四、数据库设计

### 主要数据表

**1. users (用户表)**

- id (主键)
- openid (微信 openid,唯一)
- nickname (昵称)
- avatar (头像)
- phone (手机号)
- created_at
- updated_at

**2. patients (就诊人表)**

- id (主键)
- user_id (关联用户)
- name (姓名)
- id_card (身份证号)
- phone (手机号)
- gender (性别)
- birth_date (出生日期)
- relation (与用户关系: 本人/父母/子女/其他)
- created_at
- updated_at

**3. departments (科室表)**

- id (主键)
- name (科室名称)
- description (描述)
- sort_order (排序)
- status (状态: 启用/停用)
- created_at
- updated_at

**4. doctors (医生表)**

- id (主键)
- department_id (所属科室)
- name (姓名)
- avatar (头像)
- title (职称: 主任医师/副主任医师/主治医师等)
- specialty (擅长领域)
- introduction (个人简介)
- status (状态: 在职/停诊)
- created_at
- updated_at

**5. schedules (排班表)**

- id (主键)
- doctor_id (医生 ID)
- schedule_date (排班日期)
- period (时段: morning/afternoon)
- start_time (开始时间)
- end_time (结束时间)
- total_slots (总号源数)
- available_slots (剩余号源)
- status (状态: 正常/停诊)
- created_at
- updated_at

**6. appointments (预约表)**

- id (主键)
- appointment_no (预约编号,唯一)
- user_id (用户 ID)
- patient_id (就诊人 ID)
- doctor_id (医生 ID)
- department_id (科室 ID)
- schedule_id (排班 ID)
- appointment_date (预约日期)
- appointment_time (预约时间)
- status (状态: pending 待就诊/completed 已完成/cancelled 已取消)
- symptom (症状描述)
- cancel_reason (取消原因)
- created_at
- updated_at

**7. medical_records (就诊记录表)**

- id (主键)
- appointment_id (预约 ID)
- patient_id (患者 ID)
- doctor_id (医生 ID)
- diagnosis (诊断结果)
- prescription (处方)
- advice (医嘱)
- visit_date (就诊日期)
- created_at
- updated_at

**8. admins (管理员表)**

- id (主键)
- username (用户名)
- password (密码,加密存储)
- role (角色: admin/doctor)
- status (状态)
- created_at
- updated_at

## 五、开发要求

### 代码规范

**Go 后端规范:**

1. 遵循 Go 官方代码规范和最佳实践
2. 使用分层架构: Handler -> Service -> Repository
3. 统一错误处理和响应格式
4. 使用 GORM 进行数据库操作
5. 配置文件使用 yaml 格式
6. 敏感信息通过环境变量或配置文件管理
7. 使用 Swagger 注释自动生成 API 文档

**uni-app 前端规范:**

1. 使用 Vue3 Composition API
2. 统一使用 TypeScript(可选)
3. API 请求统一封装,支持拦截器
4. 组件化开发,复用性强
5. 使用 uni-ui 组件库提升开发效率

**React 后台规范:**

1. 使用 React Hooks 和函数式组件
2. 使用 TypeScript 增强类型安全
3. 使用 Ant Design 组件库
4. 路由使用 React Router v6
5. 状态管理使用 Redux Toolkit 或 Zustand
6. API 请求使用 axios 封装

### 接口返回格式

```json
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

### 项目结构要求

**后端项目结构 (Go):**

```
backend/
├── cmd/
│   └── main.go          # 程序入口
├── internal/
│   ├── handler/         # HTTP处理器(Controller)
│   ├── service/         # 业务逻辑层
│   ├── repository/      # 数据访问层
│   ├── model/           # 数据模型
│   ├── middleware/      # 中间件
│   └── router/          # 路由配置
├── pkg/
│   ├── config/          # 配置管理
│   ├── utils/           # 工具函数
│   ├── jwt/             # JWT工具
│   └── response/        # 统一响应格式
├── docs/                # Swagger文档
├── config.yaml          # 配置文件
├── go.mod
├── go.sum
└── README.md
```

**uni-app 项目结构:**

```
uniapp-miniprogram/
├── pages/               # 页面
│   ├── index/          # 首页
│   ├── appointment/    # 预约相关页面
│   ├── user/           # 用户中心
│   └── record/         # 就诊记录
├── components/          # 组件
├── static/              # 静态资源
├── api/                 # API请求封装
├── utils/               # 工具函数
├── store/               # Vuex状态管理
├── App.vue
├── main.js
├── manifest.json        # 应用配置
├── pages.json           # 页面路由配置
└── uni.scss            # 全局样式
```

**后台管理项目结构 (React + antd):**

```
admin-frontend/
├── src/
│   ├── pages/           # 页面组件
│   │   ├── Login/      # 登录
│   │   ├── Dashboard/  # 仪表盘
│   │   ├── Appointment/# 预约管理
│   │   ├── Patient/    # 患者管理
│   │   ├── Doctor/     # 医生管理
│   │   ├── Department/ # 科室管理
│   │   └── Schedule/   # 排班管理
│   ├── components/      # 通用组件
│   ├── services/        # API服务封装
│   ├── utils/           # 工具函数
│   ├── hooks/           # 自定义Hooks
│   ├── routes/          # 路由配置
│   ├── store/           # Redux/状态管理
│   ├── styles/          # 样式文件
│   ├── App.tsx
│   └── index.tsx
├── public/
├── package.json
└── README.md
```

## 六、特殊功能说明

1. **预约冲突检测**: 同一用户不能在同一时间段预约多个医生
2. **号源控制**: 预约时自动减少可用号源,取消时自动增加
3. **就诊提醒**: 就诊前一天推送小程序订阅消息提醒
4. **数据权限**: 用户只能看到自己的预约和就诊记录
5. **排班规则**: 支持按周重复排班、临时停诊设置

## 七、业务规则详细定义

### 1. 预约规则

#### 1.1 预约时间范围

| 规则项 | 配置值 | 说明 |
|-------|-------|------|
| 可预约天数 | 7天 | 用户可预约从明天起未来7天内的号源 |
| 当天预约 | 不允许 | 不支持当天挂号，需提前至少1天 |
| 预约开放时间 | 每天 00:00 | 每天零点自动开放第7天的号源 |

```
示例：今天是12月17日
可预约范围：12月18日 ~ 12月24日
12月25日的号源将在12月18日 00:00 开放
```

#### 1.2 预约数量限制

| 规则项 | 配置值 | 说明 |
|-------|-------|------|
| 同一就诊人同一天 | 不限科室数量 | 可预约多个不同科室 |
| 同一就诊人同一医生同一天 | 最多1次 | 不可重复预约同一医生 |
| 同一就诊人同一时段 | 最多1个 | 时间冲突检测，同一时段只能约1个号 |
| 单用户每日预约上限 | 10次 | 防止恶意刷号 |

#### 1.3 预约冲突检测逻辑

```go
// 预约前校验
func CheckAppointmentConflict(patientID, doctorID int64, date string, period string) error {
    // 1. 检查是否已预约同一医生同一天
    if exists := checkSameDoctorSameDay(patientID, doctorID, date); exists {
        return errors.New("该就诊人当天已预约过该医生")
    }

    // 2. 检查同一时段是否有其他预约
    if exists := checkSamePeriod(patientID, date, period); exists {
        return errors.New("该就诊人在此时段已有其他预约")
    }

    // 3. 检查当日预约次数上限
    if count := getDailyAppointmentCount(patientID, date); count >= 10 {
        return errors.New("该就诊人当日预约次数已达上限")
    }

    return nil
}
```

### 2. 取消预约规则

#### 2.1 取消时间限制

| 规则项 | 配置值 | 说明 |
|-------|-------|------|
| 允许取消截止时间 | 就诊前1天 23:59:59 | 就诊当天不可取消 |
| 取消后号源恢复 | 立即恢复 | 取消后号源自动释放，可被他人预约 |
| 取消次数限制 | 每月5次 | 超过限制需联系客服 |

```
示例：预约了12月20日上午的号
可取消时间：12月19日 23:59:59 之前
12月20日 00:00 起无法自助取消
```

#### 2.2 取消原因选项

```go
var CancelReasons = []string{
    "行程变更",
    "预约错误",
    "身体好转，无需就诊",
    "选择其他医院",
    "其他原因",
}
```

#### 2.3 频繁取消处理

```yaml
cancel_limit:
  monthly_limit: 5              # 每月最多取消5次
  warning_threshold: 3          # 取消3次时发出警告
  exceed_action: "contact_service"  # 超限后需联系客服处理
  reset_day: 1                  # 每月1号重置计数
```

### 3. 号源管理规则

#### 3.1 排班时段定义

| 时段 | 时段标识 | 默认时间范围 | 说明 |
|-----|---------|------------|------|
| 上午 | morning | 08:00 - 12:00 | 4小时 |
| 下午 | afternoon | 14:00 - 17:30 | 3.5小时 |

#### 3.2 号源时间间隔

| 配置项 | 默认值 | 说明 |
|-------|-------|------|
| 每个号就诊时长 | 15分钟 | 可按医生/科室自定义 |
| 上午默认号源数 | 16个 | 4小时 ÷ 15分钟 = 16 |
| 下午默认号源数 | 14个 | 3.5小时 ÷ 15分钟 = 14 |

#### 3.3 号源时间分配示例

```
上午场（08:00-12:00，15分钟/号，共16个号）：
1号: 08:00-08:15
2号: 08:15-08:30
3号: 08:30-08:45
...
16号: 11:45-12:00

下午场（14:00-17:30，15分钟/号，共14个号）：
1号: 14:00-14:15
2号: 14:15-14:30
...
14号: 17:15-17:30
```

#### 3.4 号源状态流转

```
                    ┌─────────────┐
                    │   可预约    │
                    │ (available) │
                    └──────┬──────┘
                           │ 用户预约
                           ▼
                    ┌─────────────┐
         取消预约   │   已预约    │   就诊完成
        ┌──────────│  (booked)   │──────────┐
        │          └──────┬──────┘          │
        │                 │                 │
        ▼                 │ 爽约/迟到       ▼
 ┌─────────────┐          │         ┌─────────────┐
 │   可预约    │          │         │   已完成    │
 │ (available) │          │         │ (completed) │
 └─────────────┘          │         └─────────────┘
                          ▼
                   ┌─────────────┐
                   │   已作废    │
                   │ (cancelled) │
                   └─────────────┘
```

### 4. 就诊签到与爽约规则

#### 4.1 签到规则

| 规则项 | 配置值 | 说明 |
|-------|-------|------|
| 签到开始时间 | 预约时间前30分钟 | 可提前30分钟签到 |
| 签到截止时间 | 预约时间后15分钟 | 超过15分钟视为迟到 |
| 签到方式 | 小程序扫码/自助机 | 到院后扫描签到码 |

```
示例：预约时间为 09:00
签到时间窗口：08:30 ~ 09:15
09:15 之后未签到视为迟到
```

#### 4.2 迟到处理

| 情况 | 处理方式 | 说明 |
|-----|---------|------|
| 迟到15分钟内 | 正常就诊 | 在签到窗口内 |
| 迟到超过15分钟 | **预约作废** | 号源不恢复，计入爽约记录 |

```go
// 迟到处理逻辑
func HandleLateArrival(appointmentID int64) error {
    appointment := getAppointment(appointmentID)

    // 计算迟到时间
    lateMinutes := time.Now().Sub(appointment.AppointmentTime).Minutes()

    if lateMinutes > 15 {
        // 超过15分钟，作废处理
        return cancelAsNoShow(appointmentID, "迟到超过15分钟")
    }

    // 15分钟内，允许签到
    return checkIn(appointmentID)
}
```

#### 4.3 爽约处理

| 情况 | 处理方式 | 说明 |
|-----|---------|------|
| 未到院就诊 | **预约作废** | 当天结束后系统自动处理 |
| 号源处理 | 不恢复 | 爽约的号源不释放 |
| 记录保留 | 标记为 no_show | 保留爽约记录 |

#### 4.4 爽约惩罚机制

```yaml
no_show_penalty:
  enabled: true

  # 爽约记录统计周期
  period: 90                    # 90天内的爽约记录

  # 惩罚阈梯
  levels:
    - count: 1
      action: "warning"         # 第1次：发送警告消息
      message: "您有1次爽约记录，请按时就诊"

    - count: 2
      action: "warning"         # 第2次：再次警告
      message: "您已有2次爽约记录，再次爽约将限制预约功能"

    - count: 3
      action: "restrict"        # 第3次：限制预约
      restrict_days: 7          # 限制7天内不可预约
      message: "由于多次爽约，您的预约功能已被限制7天"

    - count: 5
      action: "restrict"        # 第5次：更严格限制
      restrict_days: 30         # 限制30天
      message: "由于频繁爽约，您的预约功能已被限制30天"
```

#### 4.5 自动作废定时任务

```go
// 每天 22:00 执行，处理当天未就诊的预约
func AutoCancelNoShowAppointments() {
    today := time.Now().Format("2006-01-02")

    // 查询当天状态为"待就诊"且未签到的预约
    appointments := findPendingAppointments(today)

    for _, apt := range appointments {
        // 标记为爽约
        apt.Status = "no_show"
        apt.CancelReason = "未到院就诊，系统自动作废"
        apt.UpdatedAt = time.Now()

        // 更新数据库
        updateAppointment(apt)

        // 记录爽约日志
        logNoShow(apt.UserID, apt.PatientID, apt.ID)

        // 检查是否触发惩罚
        checkAndApplyPenalty(apt.UserID)
    }
}
```

### 5. 预约状态定义

| 状态码 | 状态名 | 中文说明 | 触发条件 |
|-------|-------|---------|---------|
| pending | 待就诊 | 预约成功，等待就诊 | 创建预约成功 |
| checked_in | 已签到 | 患者已到院签到 | 扫码签到成功 |
| in_progress | 就诊中 | 正在就诊 | 医生叫号/开始接诊 |
| completed | 已完成 | 就诊结束 | 医生结束接诊 |
| cancelled | 已取消 | 用户主动取消 | 用户取消预约 |
| no_show | 已爽约 | 未到院/迟到作废 | 系统自动作废/迟到处理 |

### 6. 提醒通知规则

#### 6.1 订阅消息推送时机

| 推送类型 | 推送时间 | 内容 |
|---------|---------|------|
| 预约成功通知 | 预约成功后立即 | 预约信息确认 |
| 就诊提醒 | 就诊前1天 20:00 | 提醒明日就诊 |
| 取消成功通知 | 取消后立即 | 取消确认 |
| 爽约通知 | 爽约处理后 | 告知爽约记录及影响 |

#### 6.2 消息模板内容

```
【预约成功通知】
就诊人：{{patient_name}}
预约科室：{{department_name}}
预约医生：{{doctor_name}}
就诊时间：{{appointment_date}} {{appointment_time}}
预约单号：{{appointment_no}}
温馨提示：请提前30分钟到院签到

【就诊提醒】
就诊人：{{patient_name}}
就诊科室：{{department_name}}
就诊医生：{{doctor_name}}
就诊时间：明天 {{appointment_time}}
温馨提示：请携带身份证，提前30分钟到院签到

【爽约通知】
就诊人：{{patient_name}}
原预约时间：{{appointment_date}} {{appointment_time}}
处理结果：预约已作废
爽约次数：近90天内第{{no_show_count}}次
温馨提示：请按时就诊，多次爽约将影响预约功能
```

### 7. 业务配置汇总表

```yaml
# config.yaml - 业务规则配置
business_rules:
  # 预约规则
  appointment:
    advance_days: 7              # 可提前预约天数
    allow_same_day: false        # 是否允许当天预约
    daily_limit_per_patient: 10  # 单就诊人每日预约上限
    release_time: "00:00"        # 号源释放时间

  # 取消规则
  cancellation:
    deadline_days: 1             # 就诊前N天可取消
    deadline_time: "23:59:59"    # 截止时间
    monthly_limit: 5             # 每月取消次数上限

  # 号源规则
  slot:
    duration_minutes: 15         # 每个号时长（分钟）
    morning_start: "08:00"       # 上午开始时间
    morning_end: "12:00"         # 上午结束时间
    afternoon_start: "14:00"     # 下午开始时间
    afternoon_end: "17:30"       # 下午结束时间

  # 签到规则
  check_in:
    early_minutes: 30            # 可提前签到分钟数
    late_tolerance_minutes: 15   # 迟到容忍分钟数

  # 爽约规则
  no_show:
    auto_cancel_time: "22:00"    # 自动作废处理时间
    penalty_period_days: 90      # 爽约统计周期（天）
    penalty_thresholds:          # 惩罚阈值
      - count: 3
        restrict_days: 7
      - count: 5
        restrict_days: 30

  # 提醒规则
  reminder:
    advance_days: 1              # 提前N天提醒
    reminder_time: "20:00"       # 提醒发送时间
```

## 八、安全性设计（企业级）

### 1. 认证与授权体系

#### JWT 双 Token 机制

```
Access Token:
- 有效期: 2小时
- 用途: 接口访问认证
- 存储: 小程序端存 storage，后台存 localStorage

Refresh Token:
- 有效期: 7天
- 用途: 刷新 Access Token
- 存储: 同上，但需加密存储
- 刷新策略: Access Token 过期前 30 分钟可主动刷新
```

#### Token 刷新流程

```
1. 客户端请求接口 → 携带 Access Token
2. 服务端验证 Token:
   - 有效 → 正常返回
   - 过期 → 返回 401，错误码 TOKEN_EXPIRED
   - 无效 → 返回 401，错误码 TOKEN_INVALID
3. 客户端收到 TOKEN_EXPIRED:
   - 使用 Refresh Token 请求 /api/auth/refresh
   - 获取新的 Access Token + Refresh Token
   - 重试原请求
4. Refresh Token 也过期 → 强制重新登录
```

#### 刷新接口

```
POST /api/auth/refresh
Request:
{
  "refresh_token": "xxx"
}
Response:
{
  "code": 200,
  "data": {
    "access_token": "新token",
    "refresh_token": "新refresh_token",
    "expires_in": 7200
  }
}
```

#### Token 黑名单机制

```
场景: 用户主动退出、密码修改、账号异常
实现: Redis 存储已注销的 Token，设置与 Token 相同的过期时间
验证: 每次请求检查 Token 是否在黑名单中
```

### 2. 敏感数据安全

#### 加密存储规范

| 数据类型 | 加密方式 | 说明 |
|---------|---------|------|
| 用户密码 | bcrypt (cost=12) | 单向哈希，不可逆 |
| 身份证号 | AES-256-GCM | 可逆加密，需查询时解密 |
| 手机号 | AES-256-GCM | 可逆加密，需查询时解密 |
| 微信 openid | AES-256-GCM | 可逆加密 |

#### AES 加密配置

```yaml
# config.yaml
security:
  aes:
    key: "${AES_SECRET_KEY}"      # 32字节密钥，从环境变量读取
    algorithm: "AES-256-GCM"
  bcrypt:
    cost: 12                       # bcrypt 复杂度
```

#### 数据库存储示例

```sql
-- patients 表实际存储
id_card_encrypted: "加密后的密文"
id_card_hash: "SHA256哈希值"        -- 用于精确查询
phone_encrypted: "加密后的密文"
phone_suffix: "后4位明文"           -- 用于模糊展示和部分匹配
```

#### 数据脱敏展示规则

| 数据类型 | 脱敏规则 | 示例 |
|---------|---------|------|
| 手机号 | 保留前3后4 | 138****1234 |
| 身份证号 | 保留前6后4 | 330102****1234 |
| 姓名 | 保留首字 | 张** |
| 银行卡号 | 保留后4位 | ************1234 |

#### 脱敏接口标识

```go
// API 响应中标识脱敏数据
type PatientVO struct {
    Name       string `json:"name"`        // 脱敏后: 张**
    Phone      string `json:"phone"`       // 脱敏后: 138****1234
    IDCard     string `json:"id_card"`     // 脱敏后: 330102****1234
    PhoneFull  string `json:"phone_full,omitempty"`   // 完整数据，仅特定接口返回
}
```

### 3. 接口安全防护

#### 3.1 接口限流策略

```yaml
rate_limit:
  # 全局限流
  global:
    enabled: true
    requests: 1000        # 每秒最大请求数

  # IP 限流
  ip:
    enabled: true
    requests: 100         # 单IP每分钟最大请求数
    block_duration: 300   # 超限后封禁时间(秒)

  # 用户限流
  user:
    enabled: true
    requests: 60          # 单用户每分钟最大请求数

  # 接口级限流
  endpoints:
    "/api/user/login":
      requests: 5         # 登录接口每分钟5次
      block_duration: 600 # 超限封禁10分钟
    "/api/appointments":
      requests: 10        # 预约接口每分钟10次
```

#### 3.2 防重复提交

```
实现方式: 幂等性Token
流程:
1. 客户端请求预约前，先调用 GET /api/token/idempotent 获取幂等Token
2. 提交预约时携带该Token: Header: X-Idempotent-Token: xxx
3. 服务端验证Token（Redis存储，使用后删除）
4. Token有效期: 5分钟，一次性使用

适用接口:
- POST /api/appointments (创建预约)
- PUT /api/appointments/:id/cancel (取消预约)
- POST /api/user/patients (添加就诊人)
```

#### 3.3 请求签名验证（后台管理系统）

```
签名算法: HMAC-SHA256
签名内容: timestamp + nonce + body_md5
请求头:
  X-Timestamp: 1703001234        # 请求时间戳，允许前后5分钟
  X-Nonce: uuid                  # 随机串，防重放
  X-Signature: 签名结果

验证流程:
1. 检查时间戳是否在有效范围内
2. 检查 nonce 是否已使用（Redis记录，过期时间10分钟）
3. 重新计算签名并比对
```

#### 3.4 CORS 跨域配置

```yaml
cors:
  allowed_origins:
    - "https://admin.hospital.com"      # 后台管理域名
    - "http://localhost:3000"           # 本地开发
  allowed_methods:
    - "GET"
    - "POST"
    - "PUT"
    - "DELETE"
    - "OPTIONS"
  allowed_headers:
    - "Authorization"
    - "Content-Type"
    - "X-Idempotent-Token"
    - "X-Timestamp"
    - "X-Nonce"
    - "X-Signature"
  max_age: 86400                        # 预检请求缓存时间
  allow_credentials: true
```

#### 3.5 SQL 注入防护

```go
// ✅ 正确: 使用参数化查询
db.Where("phone = ?", phone).First(&user)

// ✅ 正确: 使用 GORM 的结构体查询
db.Where(&User{Phone: phone}).First(&user)

// ❌ 禁止: 字符串拼接
db.Where("phone = '" + phone + "'").First(&user)

// 代码审查检查项:
// 1. 禁止使用 Raw SQL 拼接用户输入
// 2. 使用 GORM 的 Scopes 封装查询条件
// 3. 定期进行 SQL 注入扫描
```

#### 3.6 XSS 防护

```go
// 输入过滤 - 在 Handler 层
func SanitizeInput(input string) string {
    return bluemonday.StrictPolicy().Sanitize(input)
}

// 输出编码 - 模板渲染时自动转义
// 响应头设置
c.Header("X-Content-Type-Options", "nosniff")
c.Header("X-XSS-Protection", "1; mode=block")
c.Header("Content-Security-Policy", "default-src 'self'")
```

### 4. 审计日志系统

#### 日志分类

| 日志类型 | 存储位置 | 保留期限 | 内容 |
|---------|---------|---------|------|
| 访问日志 | 文件/ELK | 30天 | 请求路径、IP、耗时、状态码 |
| 操作日志 | 数据库 | 永久 | 关键业务操作记录 |
| 登录日志 | 数据库 | 90天 | 登录时间、IP、设备、结果 |
| 安全日志 | 文件/ELK | 180天 | 异常请求、攻击行为 |
| 错误日志 | 文件/ELK | 30天 | 系统异常、错误堆栈 |

#### 操作日志表设计

```sql
CREATE TABLE operation_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT COMMENT '操作用户ID',
    user_type VARCHAR(20) COMMENT '用户类型: user/admin',
    module VARCHAR(50) COMMENT '模块: appointment/patient/doctor',
    action VARCHAR(50) COMMENT '操作: create/update/delete/cancel',
    target_id BIGINT COMMENT '操作对象ID',
    target_type VARCHAR(50) COMMENT '对象类型',
    before_data JSON COMMENT '操作前数据',
    after_data JSON COMMENT '操作后数据',
    ip VARCHAR(50) COMMENT '操作IP',
    user_agent VARCHAR(500) COMMENT '客户端信息',
    result VARCHAR(20) COMMENT '结果: success/fail',
    error_msg VARCHAR(500) COMMENT '错误信息',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_module_action (module, action),
    INDEX idx_created_at (created_at)
) COMMENT '操作日志表';
```

#### 登录日志表设计

```sql
CREATE TABLE login_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT COMMENT '用户ID',
    user_type VARCHAR(20) COMMENT '用户类型: user/admin',
    login_type VARCHAR(20) COMMENT '登录方式: wechat/password',
    ip VARCHAR(50) COMMENT '登录IP',
    location VARCHAR(100) COMMENT 'IP归属地',
    device VARCHAR(200) COMMENT '设备信息',
    os VARCHAR(50) COMMENT '操作系统',
    browser VARCHAR(50) COMMENT '浏览器',
    result VARCHAR(20) COMMENT '结果: success/fail',
    fail_reason VARCHAR(100) COMMENT '失败原因',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
) COMMENT '登录日志表';
```

#### 需要记录的关键操作

```
用户端:
- 登录/退出
- 创建预约、取消预约
- 添加/修改/删除就诊人
- 修改个人信息

管理端:
- 登录/退出
- 预约状态变更
- 医生/科室/排班的增删改
- 数据导出操作
- 权限变更操作
```

### 5. 权限控制体系 (RBAC)

#### 角色定义

| 角色 | 权限范围 |
|------|---------|
| super_admin | 超级管理员，全部权限 |
| admin | 普通管理员，除权限管理外的全部功能 |
| doctor | 医生角色，查看自己的排班和预约 |
| receptionist | 前台，预约管理和患者查询 |

#### 权限表设计

```sql
-- 权限表
CREATE TABLE permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    code VARCHAR(100) UNIQUE COMMENT '权限编码',
    name VARCHAR(100) COMMENT '权限名称',
    module VARCHAR(50) COMMENT '所属模块',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
) COMMENT '权限表';

-- 角色表
CREATE TABLE roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    code VARCHAR(50) UNIQUE COMMENT '角色编码',
    name VARCHAR(50) COMMENT '角色名称',
    description VARCHAR(200) COMMENT '描述',
    status TINYINT DEFAULT 1 COMMENT '状态: 1启用 0禁用',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) COMMENT '角色表';

-- 角色权限关联表
CREATE TABLE role_permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    role_id BIGINT NOT NULL,
    permission_id BIGINT NOT NULL,
    UNIQUE KEY uk_role_permission (role_id, permission_id)
) COMMENT '角色权限关联表';

-- 管理员角色关联表
CREATE TABLE admin_roles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    admin_id BIGINT NOT NULL,
    role_id BIGINT NOT NULL,
    UNIQUE KEY uk_admin_role (admin_id, role_id)
) COMMENT '管理员角色关联表';
```

#### 权限编码规范

```
格式: 模块:操作
示例:
- appointment:list     预约列表
- appointment:detail   预约详情
- appointment:cancel   取消预约
- appointment:export   导出预约
- doctor:list          医生列表
- doctor:create        添加医生
- doctor:update        编辑医生
- doctor:delete        删除医生
- schedule:list        排班列表
- schedule:create      创建排班
- statistics:view      查看统计
```

#### 权限验证中间件

```go
// 权限验证中间件
func RequirePermission(permissions ...string) gin.HandlerFunc {
    return func(c *gin.Context) {
        adminID := c.GetInt64("admin_id")

        // 获取用户所有权限
        userPermissions := getAdminPermissions(adminID)

        // 检查是否拥有所需权限
        for _, p := range permissions {
            if !contains(userPermissions, p) {
                c.JSON(403, response.Error(403, "无操作权限"))
                c.Abort()
                return
            }
        }
        c.Next()
    }
}

// 使用示例
router.DELETE("/admin/doctors/:id",
    middleware.RequirePermission("doctor:delete"),
    handler.DeleteDoctor)
```

### 6. 数据安全补充措施

#### 数据备份策略

```yaml
backup:
  database:
    full_backup: "0 2 * * *"          # 每天凌晨2点全量备份
    incremental: "0 */6 * * *"        # 每6小时增量备份
    retention: 30                      # 保留30天
    storage: "oss://backup-bucket/"   # 备份存储位置

  sensitive_data:
    encryption: true                   # 备份文件加密
    algorithm: "AES-256"
```

#### 数据库安全配置

```sql
-- 创建专用数据库账号（最小权限原则）
-- 应用账号：只有 CRUD 权限
CREATE USER 'app_user'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON hospital_db.* TO 'app_user'@'%';

-- 只读账号：用于报表查询
CREATE USER 'readonly'@'%' IDENTIFIED BY 'strong_password';
GRANT SELECT ON hospital_db.* TO 'readonly'@'%';

-- 禁止远程 root 登录
DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1');
FLUSH PRIVILEGES;
```

### 7. HTTPS 与传输安全

```yaml
server:
  # 强制 HTTPS
  https_only: true

  # TLS 配置
  tls:
    min_version: "TLS1.2"
    cert_file: "/etc/ssl/certs/server.crt"
    key_file: "/etc/ssl/private/server.key"

  # 安全响应头
  security_headers:
    Strict-Transport-Security: "max-age=31536000; includeSubDomains"
    X-Frame-Options: "DENY"
    X-Content-Type-Options: "nosniff"
    X-XSS-Protection: "1; mode=block"
    Content-Security-Policy: "default-src 'self'"
```

### 8. 密钥与配置管理

#### 环境变量清单

```bash
# .env.example
# ====== 数据库配置 ======
DB_HOST=localhost
DB_PORT=3306
DB_NAME=hospital_db
DB_USER=app_user
DB_PASSWORD=                    # 必填，数据库密码

# ====== Redis配置 ======
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=                 # 必填，Redis密码

# ====== JWT配置 ======
JWT_SECRET=                     # 必填，至少32位随机字符串
JWT_REFRESH_SECRET=             # 必填，至少32位随机字符串

# ====== 加密配置 ======
AES_SECRET_KEY=                 # 必填，32字节AES密钥

# ====== 微信配置 ======
WECHAT_APP_ID=
WECHAT_APP_SECRET=

# ====== 其他 ======
GIN_MODE=release               # 生产环境必须为release
LOG_LEVEL=info
```

#### 密钥轮换策略

```
JWT密钥: 每90天轮换一次
AES密钥: 每180天轮换一次
数据库密码: 每90天轮换一次

轮换流程:
1. 生成新密钥
2. 配置系统同时支持新旧密钥
3. 逐步迁移（JWT等待旧Token过期）
4. 移除旧密钥支持
```

## 九、错误码规范

### 1. 错误码设计原则

#### 1.1 错误码格式

```
错误码格式：AABBCCC（7位数字）

AA   - 系统/端标识（2位）
BB   - 模块标识（2位）
CCC  - 具体错误（3位）

示例：1001001
10   - 小程序端
01   - 用户模块
001  - 具体错误：用户不存在
```

#### 1.2 系统标识定义

| 标识 | 说明 |
|-----|------|
| 10 | 小程序端业务错误 |
| 20 | 后台管理端业务错误 |
| 30 | 通用/系统级错误 |
| 40 | 第三方服务错误 |

#### 1.3 模块标识定义

| 标识 | 模块 |
|-----|------|
| 01 | 用户模块 |
| 02 | 就诊人模块 |
| 03 | 预约模块 |
| 04 | 科室模块 |
| 05 | 医生模块 |
| 06 | 排班模块 |
| 07 | 就诊记录模块 |
| 08 | 统计模块 |
| 09 | 权限模块 |
| 99 | 通用模块 |

### 2. 响应格式规范

#### 2.1 成功响应

```json
{
  "code": 0,
  "message": "success",
  "data": {
    // 业务数据
  }
}
```

#### 2.2 错误响应

```json
{
  "code": 1001001,
  "message": "用户不存在",
  "data": null,
  "details": {
    "field": "user_id",
    "value": "12345",
    "suggestion": "请检查用户ID是否正确"
  },
  "request_id": "req_abc123xyz",
  "timestamp": 1703001234
}
```

#### 2.3 参数校验错误响应

```json
{
  "code": 3099001,
  "message": "参数校验失败",
  "data": null,
  "errors": [
    {
      "field": "phone",
      "message": "手机号格式不正确",
      "value": "1234567"
    },
    {
      "field": "id_card",
      "message": "身份证号不能为空",
      "value": ""
    }
  ],
  "request_id": "req_abc123xyz",
  "timestamp": 1703001234
}
```

### 3. 通用错误码（30xxxxx）

#### 3.1 系统级错误（3000xxx）

| 错误码 | 错误信息 | 说明 | HTTP状态码 |
|-------|---------|------|-----------|
| 3000001 | 系统繁忙，请稍后重试 | 系统内部错误 | 500 |
| 3000002 | 服务暂时不可用 | 服务降级/熔断 | 503 |
| 3000003 | 请求超时 | 接口超时 | 504 |
| 3000004 | 数据库操作失败 | DB错误 | 500 |
| 3000005 | 缓存操作失败 | Redis错误 | 500 |
| 3000006 | 文件上传失败 | 文件服务错误 | 500 |
| 3000007 | 数据不存在 | 通用数据未找到 | 404 |
| 3000008 | 数据已存在 | 通用重复数据 | 409 |
| 3000009 | 操作过于频繁 | 触发限流 | 429 |
| 3000010 | 请求被拒绝 | 触发风控 | 403 |

#### 3.2 认证授权错误（3001xxx）

| 错误码 | 错误信息 | 说明 | HTTP状态码 |
|-------|---------|------|-----------|
| 3001001 | 未登录或登录已过期 | Token无效/过期 | 401 |
| 3001002 | Token已失效，请重新登录 | Token在黑名单 | 401 |
| 3001003 | 登录凭证已过期，请刷新 | Access Token过期，需刷新 | 401 |
| 3001004 | 刷新凭证已过期，请重新登录 | Refresh Token过期 | 401 |
| 3001005 | 无权限访问 | 权限不足 | 403 |
| 3001006 | 账号已被禁用 | 账号状态异常 | 403 |
| 3001007 | 账号或密码错误 | 登录失败 | 401 |
| 3001008 | 密码错误次数过多，账号已锁定 | 登录锁定 | 423 |
| 3001009 | 签名验证失败 | 请求签名错误 | 401 |
| 3001010 | 请求已过期 | 时间戳超出范围 | 401 |

#### 3.3 参数校验错误（3099xxx）

| 错误码 | 错误信息 | 说明 | HTTP状态码 |
|-------|---------|------|-----------|
| 3099001 | 参数校验失败 | 通用参数错误 | 400 |
| 3099002 | 缺少必要参数 | 必填参数缺失 | 400 |
| 3099003 | 参数格式错误 | 格式不符合要求 | 400 |
| 3099004 | 参数值超出范围 | 值超出允许范围 | 400 |
| 3099005 | 手机号格式不正确 | 手机号校验失败 | 400 |
| 3099006 | 身份证号格式不正确 | 身份证校验失败 | 400 |
| 3099007 | 日期格式不正确 | 日期格式错误 | 400 |
| 3099008 | 请求体不能为空 | Body为空 | 400 |
| 3099009 | JSON格式解析失败 | JSON格式错误 | 400 |
| 3099010 | 幂等Token无效或已使用 | 防重复提交 | 400 |

### 4. 用户模块错误码（xx01xxx）

#### 4.1 小程序端用户错误（1001xxx）

| 错误码 | 错误信息 | 说明 |
|-------|---------|------|
| 1001001 | 用户不存在 | 用户ID无效 |
| 1001002 | 微信登录失败 | code无效或已过期 |
| 1001003 | 获取微信用户信息失败 | 微信接口调用失败 |
| 1001004 | 用户信息不完整，请完善信息 | 缺少必要信息 |
| 1001005 | 手机号已被绑定 | 手机号重复 |
| 1001006 | 该手机号已注册，请直接登录 | 手机号已存在 |
| 1001007 | 用户已被禁用 | 账号状态异常 |
| 1001008 | 预约功能已被限制 | 爽约惩罚中 |
| 1001009 | 预约功能限制中，剩余{{days}}天 | 爽约惩罚倒计时 |

#### 4.2 后台管理员错误（2001xxx）

| 错误码 | 错误信息 | 说明 |
|-------|---------|------|
| 2001001 | 管理员不存在 | 管理员ID无效 |
| 2001002 | 用户名或密码错误 | 登录失败 |
| 2001003 | 账号已被禁用 | 管理员状态异常 |
| 2001004 | 旧密码错误 | 修改密码失败 |
| 2001005 | 用户名已存在 | 创建管理员失败 |
| 2001006 | 无法删除自己的账号 | 操作限制 |
| 2001007 | 无法修改超级管理员 | 权限限制 |

### 5. 就诊人模块错误码（xx02xxx）

| 错误码 | 错误信息 | 说明 |
|-------|---------|------|
| 1002001 | 就诊人不存在 | 就诊人ID无效 |
| 1002002 | 就诊人数量已达上限 | 最多添加N个 |
| 1002003 | 该身份证号已添加过 | 身份证重复 |
| 1002004 | 无权操作该就诊人 | 非本人就诊人 |
| 1002005 | 就诊人信息不完整 | 缺少必要信息 |
| 1002006 | 就诊人存在进行中的预约，无法删除 | 有关联预约 |
| 1002007 | 身份证号与姓名不匹配 | 实名校验失败 |

### 6. 预约模块错误码（xx03xxx）

#### 6.1 创建预约错误

| 错误码 | 错误信息 | 说明 |
|-------|---------|------|
| 1003001 | 预约不存在 | 预约ID无效 |
| 1003002 | 该号源已被预约 | 号源已满 |
| 1003003 | 该时段已有预约 | 时间冲突 |
| 1003004 | 该就诊人当天已预约过该医生 | 重复预约 |
| 1003005 | 今日预约次数已达上限 | 每日限制 |
| 1003006 | 该日期不可预约 | 超出可预约范围 |
| 1003007 | 不支持当天预约 | 当天预约限制 |
| 1003008 | 该排班已停诊 | 排班状态异常 |
| 1003009 | 医生当前不接诊 | 医生状态异常 |
| 1003010 | 科室当前未开放 | 科室状态异常 |
| 1003011 | 预约功能已被限制 | 爽约惩罚中 |

#### 6.2 取消预约错误

| 错误码 | 错误信息 | 说明 |
|-------|---------|------|
| 1003020 | 该预约无法取消 | 状态不允许 |
| 1003021 | 已过取消截止时间 | 就诊当天 |
| 1003022 | 本月取消次数已达上限 | 月度限制 |
| 1003023 | 无权取消该预约 | 非本人预约 |
| 1003024 | 预约已取消，请勿重复操作 | 重复取消 |
| 1003025 | 预约已完成，无法取消 | 已就诊 |

#### 6.3 预约状态错误

| 错误码 | 错误信息 | 说明 |
|-------|---------|------|
| 1003030 | 预约状态异常 | 状态不符合预期 |
| 1003031 | 还未到签到时间 | 提前签到限制 |
| 1003032 | 签到时间已过 | 迟到作废 |
| 1003033 | 已签到，请勿重复操作 | 重复签到 |
| 1003034 | 预约已作废 | 爽约/迟到 |

#### 6.4 后台预约管理错误（2003xxx）

| 错误码 | 错误信息 | 说明 |
|-------|---------|------|
| 2003001 | 预约不存在 | 预约ID无效 |
| 2003002 | 无权操作该预约 | 权限不足 |
| 2003003 | 该状态不允许此操作 | 状态流转错误 |
| 2003004 | 导出数据量过大，请缩小范围 | 导出限制 |
| 2003005 | 导出任务正在进行中 | 重复导出 |

### 7. 科室模块错误码（xx04xxx）

| 错误码 | 错误信息 | 说明 |
|-------|---------|------|
| 1004001 | 科室不存在 | 科室ID无效 |
| 1004002 | 科室已停用 | 状态异常 |
| 2004001 | 科室名称已存在 | 名称重复 |
| 2004002 | 科室下存在医生，无法删除 | 有关联数据 |
| 2004003 | 科室下存在进行中的预约，无法停用 | 有关联预约 |

### 8. 医生模块错误码（xx05xxx）

| 错误码 | 错误信息 | 说明 |
|-------|---------|------|
| 1005001 | 医生不存在 | 医生ID无效 |
| 1005002 | 医生已停诊 | 状态异常 |
| 2005001 | 医生工号已存在 | 工号重复 |
| 2005002 | 医生存在排班，无法删除 | 有关联数据 |
| 2005003 | 医生存在进行中的预约，无法停诊 | 有关联预约 |
| 2005004 | 头像文件格式不支持 | 仅支持jpg/png |
| 2005005 | 头像文件大小超过限制 | 最大2MB |

### 9. 排班模块错误码（xx06xxx）

| 错误码 | 错误信息 | 说明 |
|-------|---------|------|
| 1006001 | 排班不存在 | 排班ID无效 |
| 1006002 | 该时段无排班 | 未排班 |
| 1006003 | 该排班已停诊 | 临时停诊 |
| 2006001 | 该医生该时段已有排班 | 排班冲突 |
| 2006002 | 排班日期不能早于今天 | 日期无效 |
| 2006003 | 排班存在预约，无法删除 | 有关联预约 |
| 2006004 | 排班存在预约，无法停诊 | 有关联预约 |
| 2006005 | 号源数量不能小于已预约数 | 号源限制 |
| 2006006 | 批量排班日期范围过大 | 最大30天 |

### 10. 就诊记录模块错误码（xx07xxx）

| 错误码 | 错误信息 | 说明 |
|-------|---------|------|
| 1007001 | 就诊记录不存在 | 记录ID无效 |
| 1007002 | 无权查看该记录 | 非本人记录 |
| 2007001 | 关联的预约不存在 | 预约ID无效 |
| 2007002 | 该预约已有就诊记录 | 记录重复 |
| 2007003 | 预约状态不正确，无法创建记录 | 状态异常 |

### 11. 第三方服务错误码（40xxxxx）

| 错误码 | 错误信息 | 说明 |
|-------|---------|------|
| 4001001 | 微信服务暂时不可用 | 微信接口错误 |
| 4001002 | 微信code无效或已过期 | 登录code失效 |
| 4001003 | 微信接口调用频率超限 | 限流 |
| 4002001 | 短信服务暂时不可用 | 短信接口错误 |
| 4002002 | 短信发送过于频繁 | 限流 |
| 4002003 | 短信验证码错误 | 验证失败 |
| 4002004 | 短信验证码已过期 | 超时 |
| 4003001 | 文件存储服务暂时不可用 | OSS错误 |
| 4003002 | 文件上传失败 | 上传错误 |

### 12. 错误码常量定义（Go）

```go
package errorcode

// 系统级错误码
const (
    Success         = 0       // 成功
    SystemError     = 3000001 // 系统繁忙
    ServiceUnavail  = 3000002 // 服务不可用
    RequestTimeout  = 3000003 // 请求超时
    DBError         = 3000004 // 数据库错误
    CacheError      = 3000005 // 缓存错误
    UploadError     = 3000006 // 上传失败
    DataNotFound    = 3000007 // 数据不存在
    DataExists      = 3000008 // 数据已存在
    TooManyRequests = 3000009 // 请求过于频繁
    RequestDenied   = 3000010 // 请求被拒绝
)

// 认证授权错误码
const (
    Unauthorized       = 3001001 // 未登录
    TokenInvalid       = 3001002 // Token无效
    TokenExpired       = 3001003 // Token过期
    RefreshTokenExpired = 3001004 // RefreshToken过期
    Forbidden          = 3001005 // 无权限
    AccountDisabled    = 3001006 // 账号禁用
    LoginFailed        = 3001007 // 登录失败
    AccountLocked      = 3001008 // 账号锁定
    SignatureError     = 3001009 // 签名错误
    RequestExpired     = 3001010 // 请求过期
)

// 参数校验错误码
const (
    ValidationError   = 3099001 // 参数校验失败
    MissingParam      = 3099002 // 缺少参数
    InvalidFormat     = 3099003 // 格式错误
    OutOfRange        = 3099004 // 超出范围
    InvalidPhone      = 3099005 // 手机号错误
    InvalidIDCard     = 3099006 // 身份证错误
    InvalidDate       = 3099007 // 日期错误
    EmptyBody         = 3099008 // 请求体为空
    JSONParseError    = 3099009 // JSON解析错误
    IdempotentInvalid = 3099010 // 幂等Token无效
)

// 预约模块错误码
const (
    AppointmentNotFound    = 1003001 // 预约不存在
    SlotUnavailable        = 1003002 // 号源已满
    TimeConflict           = 1003003 // 时间冲突
    DuplicateAppointment   = 1003004 // 重复预约
    DailyLimitExceeded     = 1003005 // 每日上限
    DateNotAvailable       = 1003006 // 日期不可预约
    SameDayNotAllowed      = 1003007 // 不支持当天预约
    ScheduleClosed         = 1003008 // 已停诊
    DoctorUnavailable      = 1003009 // 医生不接诊
    DepartmentClosed       = 1003010 // 科室未开放
    AppointmentRestricted  = 1003011 // 预约被限制

    CannotCancel           = 1003020 // 无法取消
    CancelDeadlinePassed   = 1003021 // 过取消截止时间
    MonthlyCancelLimit     = 1003022 // 月取消上限
    NoCancelPermission     = 1003023 // 无权取消
    AlreadyCancelled       = 1003024 // 已取消
    AlreadyCompleted       = 1003025 // 已完成
)
```

### 13. 错误码常量定义（TypeScript - 前端）

```typescript
// errorCode.ts

export const ErrorCode = {
  // 成功
  SUCCESS: 0,

  // 系统级错误
  SYSTEM_ERROR: 3000001,
  SERVICE_UNAVAILABLE: 3000002,
  TOO_MANY_REQUESTS: 3000009,

  // 认证错误
  UNAUTHORIZED: 3001001,
  TOKEN_INVALID: 3001002,
  TOKEN_EXPIRED: 3001003,
  REFRESH_TOKEN_EXPIRED: 3001004,
  FORBIDDEN: 3001005,
  ACCOUNT_DISABLED: 3001006,

  // 参数错误
  VALIDATION_ERROR: 3099001,
  INVALID_PHONE: 3099005,
  INVALID_ID_CARD: 3099006,

  // 预约错误
  APPOINTMENT_NOT_FOUND: 1003001,
  SLOT_UNAVAILABLE: 1003002,
  TIME_CONFLICT: 1003003,
  DUPLICATE_APPOINTMENT: 1003004,
  DAILY_LIMIT_EXCEEDED: 1003005,
  DATE_NOT_AVAILABLE: 1003006,
  SAME_DAY_NOT_ALLOWED: 1003007,
  APPOINTMENT_RESTRICTED: 1003011,
  CANCEL_DEADLINE_PASSED: 1003021,
  MONTHLY_CANCEL_LIMIT: 1003022,
} as const;

// 错误码对应的用户友好提示
export const ErrorMessage: Record<number, string> = {
  [ErrorCode.SYSTEM_ERROR]: '系统繁忙，请稍后重试',
  [ErrorCode.TOO_MANY_REQUESTS]: '操作过于频繁，请稍后重试',
  [ErrorCode.UNAUTHORIZED]: '请先登录',
  [ErrorCode.TOKEN_EXPIRED]: '登录已过期，请重新登录',
  [ErrorCode.SLOT_UNAVAILABLE]: '该号源已被预约，请选择其他时段',
  [ErrorCode.TIME_CONFLICT]: '该时段已有其他预约',
  [ErrorCode.DAILY_LIMIT_EXCEEDED]: '今日预约次数已达上限',
  [ErrorCode.CANCEL_DEADLINE_PASSED]: '已过取消截止时间，无法取消',
  // ...
};
```

### 14. 前端错误处理指南

#### 14.1 统一错误处理（uni-app）

```typescript
// utils/request.ts
import { ErrorCode } from './errorCode';

const handleError = (code: number, message: string) => {
  switch (code) {
    // Token过期，需要刷新
    case ErrorCode.TOKEN_EXPIRED:
      return refreshTokenAndRetry();

    // RefreshToken过期，强制登录
    case ErrorCode.REFRESH_TOKEN_EXPIRED:
    case ErrorCode.UNAUTHORIZED:
    case ErrorCode.TOKEN_INVALID:
      clearToken();
      uni.reLaunch({ url: '/pages/login/index' });
      break;

    // 业务限制类错误，显示Toast
    case ErrorCode.SLOT_UNAVAILABLE:
    case ErrorCode.TIME_CONFLICT:
    case ErrorCode.DAILY_LIMIT_EXCEEDED:
    case ErrorCode.CANCEL_DEADLINE_PASSED:
      uni.showToast({ title: message, icon: 'none' });
      break;

    // 系统错误，显示通用提示
    case ErrorCode.SYSTEM_ERROR:
    case ErrorCode.SERVICE_UNAVAILABLE:
      uni.showToast({ title: '系统繁忙，请稍后重试', icon: 'none' });
      break;

    // 限流错误
    case ErrorCode.TOO_MANY_REQUESTS:
      uni.showToast({ title: '操作太快了，请稍后再试', icon: 'none' });
      break;

    // 预约被限制（爽约惩罚）
    case ErrorCode.APPOINTMENT_RESTRICTED:
      uni.showModal({
        title: '提示',
        content: message,
        showCancel: false,
      });
      break;

    // 其他错误
    default:
      uni.showToast({ title: message || '操作失败', icon: 'none' });
  }
};
```

#### 14.2 统一错误处理（React后台）

```typescript
// utils/request.ts
import { message, Modal } from 'antd';
import { ErrorCode } from './errorCode';

const handleError = (code: number, msg: string) => {
  switch (code) {
    case ErrorCode.TOKEN_EXPIRED:
      return refreshTokenAndRetry();

    case ErrorCode.REFRESH_TOKEN_EXPIRED:
    case ErrorCode.UNAUTHORIZED:
      Modal.warning({
        title: '登录已过期',
        content: '请重新登录',
        onOk: () => {
          clearToken();
          window.location.href = '/login';
        },
      });
      break;

    case ErrorCode.FORBIDDEN:
      message.error('无权限执行此操作');
      break;

    case ErrorCode.TOO_MANY_REQUESTS:
      message.warning('操作过于频繁，请稍后重试');
      break;

    case ErrorCode.SYSTEM_ERROR:
      message.error('系统繁忙，请稍后重试');
      break;

    default:
      message.error(msg || '操作失败');
  }
};
```

### 15. 错误码速查表

| 错误码范围 | 含义 |
|-----------|------|
| 0 | 成功 |
| 10xxxxx | 小程序端业务错误 |
| 20xxxxx | 后台管理端业务错误 |
| 3000xxx | 系统级错误 |
| 3001xxx | 认证授权错误 |
| 3099xxx | 参数校验错误 |
| 40xxxxx | 第三方服务错误 |
| xx01xxx | 用户模块 |
| xx02xxx | 就诊人模块 |
| xx03xxx | 预约模块 |
| xx04xxx | 科室模块 |
| xx05xxx | 医生模块 |
| xx06xxx | 排班模块 |
| xx07xxx | 就诊记录模块 |

## 十、UI/UX 设计规范

### 1. 设计原则

```
核心理念：简约、庄重、专业、可信赖

✓ 简约清晰 - 去除冗余装饰，信息层次分明
✓ 庄重专业 - 体现医疗行业的严谨与专业性
✓ 易用友好 - 操作直观，适合各年龄段用户
✓ 无障碍设计 - 足够的对比度，清晰的文字
```

### 2. 配色方案

#### 2.1 主色调

| 颜色名称 | 色值 | 用途 |
|---------|------|------|
| **主白色** | `#FFFFFF` | 页面背景、卡片背景 |
| **浅灰背景** | `#F5F7FA` | 页面底色、分隔区域 |
| **深灰背景** | `#F0F2F5` | 次级背景、禁用状态背景 |

#### 2.2 功能色

| 颜色名称 | 色值 | 用途 |
|---------|------|------|
| **医疗蓝** | `#1890FF` | 主要按钮、链接、重点强调 |
| **深蓝色** | `#096DD9` | 按钮hover、active状态 |
| **浅蓝色** | `#E6F7FF` | 选中状态背景、轻提示背景 |
| **成功绿** | `#52C41A` | 成功状态、已完成 |
| **警告橙** | `#FAAD14` | 警告提示、待处理 |
| **错误红** | `#FF4D4F` | 错误提示、删除、取消 |

#### 2.3 文字色

| 颜色名称 | 色值 | 用途 |
|---------|------|------|
| **主文字** | `#262626` | 标题、重要文字 |
| **正文文字** | `#595959` | 正文内容 |
| **辅助文字** | `#8C8C8C` | 说明文字、时间 |
| **禁用文字** | `#BFBFBF` | 禁用状态文字 |
| **白色文字** | `#FFFFFF` | 深色背景上的文字 |

#### 2.4 边框色

| 颜色名称 | 色值 | 用途 |
|---------|------|------|
| **标准边框** | `#D9D9D9` | 输入框、卡片边框 |
| **浅边框** | `#E8E8E8` | 分割线、列表边框 |
| **深边框** | `#BFBFBF` | hover状态边框 |

#### 2.5 配色示例

```scss
// variables.scss - 小程序/后台通用
$color-primary: #1890FF;        // 主色
$color-primary-dark: #096DD9;   // 主色深
$color-primary-light: #E6F7FF;  // 主色浅

$color-success: #52C41A;        // 成功
$color-warning: #FAAD14;        // 警告
$color-error: #FF4D4F;          // 错误

$color-bg-primary: #FFFFFF;     // 主背景
$color-bg-secondary: #F5F7FA;   // 次背景
$color-bg-tertiary: #F0F2F5;    // 三级背景

$color-text-primary: #262626;   // 主文字
$color-text-regular: #595959;   // 正文
$color-text-secondary: #8C8C8C; // 辅助
$color-text-disabled: #BFBFBF;  // 禁用

$color-border: #D9D9D9;         // 边框
$color-border-light: #E8E8E8;   // 浅边框
```

### 3. 字体规范

#### 3.1 字体族

```css
/* 小程序 */
font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC',
             'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;

/* 后台管理 */
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
             'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei',
             'Helvetica Neue', sans-serif;
```

#### 3.2 字号规范

**小程序端：**

| 用途 | 字号 | 字重 | 行高 |
|-----|------|------|------|
| 大标题 | 40rpx (20px) | 600 | 1.4 |
| 页面标题 | 36rpx (18px) | 600 | 1.4 |
| 模块标题 | 32rpx (16px) | 500 | 1.4 |
| 正文 | 28rpx (14px) | 400 | 1.6 |
| 辅助文字 | 24rpx (12px) | 400 | 1.5 |
| 小字说明 | 22rpx (11px) | 400 | 1.5 |

**后台管理端：**

| 用途 | 字号 | 字重 | 行高 |
|-----|------|------|------|
| 页面标题 | 20px | 600 | 1.4 |
| 模块标题 | 16px | 500 | 1.4 |
| 正文/表格 | 14px | 400 | 1.6 |
| 辅助文字 | 12px | 400 | 1.5 |

### 4. 间距规范

#### 4.1 基础间距（8px 倍数原则）

```scss
$spacing-xs: 4px;    // 极小间距
$spacing-sm: 8px;    // 小间距
$spacing-md: 16px;   // 中等间距
$spacing-lg: 24px;   // 大间距
$spacing-xl: 32px;   // 超大间距
```

#### 4.2 页面间距

```scss
// 小程序
$page-padding: 32rpx;           // 页面左右边距
$card-padding: 24rpx;           // 卡片内边距
$section-gap: 24rpx;            // 模块间距

// 后台管理
$page-padding: 24px;            // 页面内边距
$card-padding: 24px;            // 卡片内边距
$table-cell-padding: 16px;      // 表格单元格间距
```

### 5. 圆角规范

```scss
$radius-sm: 4px;     // 小圆角（按钮、输入框）
$radius-md: 8px;     // 中圆角（卡片、弹窗）
$radius-lg: 12px;    // 大圆角（图片、头像）
$radius-xl: 16px;    // 超大圆角（底部弹窗）
$radius-round: 50%;  // 圆形（头像、图标按钮）
```

### 6. 阴影规范

```scss
// 卡片阴影（轻微）
$shadow-card: 0 2px 8px rgba(0, 0, 0, 0.06);

// 弹窗阴影
$shadow-modal: 0 4px 16px rgba(0, 0, 0, 0.12);

// 下拉菜单阴影
$shadow-dropdown: 0 2px 12px rgba(0, 0, 0, 0.1);

// 悬浮阴影
$shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.08);
```

### 7. 组件样式规范

#### 7.1 按钮样式

```scss
// 主要按钮
.btn-primary {
  background: $color-primary;
  color: #FFFFFF;
  border: none;
  border-radius: $radius-sm;
  height: 44px;                  // 后台: 36px
  font-size: 16px;               // 后台: 14px

  &:hover { background: $color-primary-dark; }
  &:disabled { background: #A0CFFF; cursor: not-allowed; }
}

// 次要按钮
.btn-default {
  background: #FFFFFF;
  color: $color-text-primary;
  border: 1px solid $color-border;

  &:hover { color: $color-primary; border-color: $color-primary; }
}

// 危险按钮
.btn-danger {
  background: #FFFFFF;
  color: $color-error;
  border: 1px solid $color-error;

  &:hover { background: #FFF1F0; }
}
```

#### 7.2 输入框样式

```scss
.input {
  height: 44px;                  // 后台: 36px
  border: 1px solid $color-border;
  border-radius: $radius-sm;
  padding: 0 12px;
  font-size: 14px;
  background: #FFFFFF;

  &:focus {
    border-color: $color-primary;
    box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.1);
  }

  &::placeholder { color: $color-text-disabled; }
  &:disabled { background: $color-bg-tertiary; }
}
```

#### 7.3 卡片样式

```scss
.card {
  background: #FFFFFF;
  border-radius: $radius-md;
  padding: $card-padding;
  box-shadow: $shadow-card;

  // 或使用边框风格（更简约）
  // border: 1px solid $color-border-light;
  // box-shadow: none;
}
```

#### 7.4 状态标签

```scss
// 待就诊 - 蓝色
.tag-pending {
  background: #E6F7FF;
  color: #1890FF;
  border: 1px solid #91D5FF;
}

// 已签到 - 青色
.tag-checked-in {
  background: #E6FFFB;
  color: #13C2C2;
  border: 1px solid #87E8DE;
}

// 已完成 - 绿色
.tag-completed {
  background: #F6FFED;
  color: #52C41A;
  border: 1px solid #B7EB8F;
}

// 已取消 - 灰色
.tag-cancelled {
  background: #FAFAFA;
  color: #8C8C8C;
  border: 1px solid #D9D9D9;
}

// 已爽约 - 红色
.tag-no-show {
  background: #FFF1F0;
  color: #FF4D4F;
  border: 1px solid #FFA39E;
}
```

### 8. 小程序页面设计规范

#### 8.1 页面结构

```
┌─────────────────────────┐
│      状态栏 (系统)       │
├─────────────────────────┤
│      导航栏 (标题)       │  高度: 44px
├─────────────────────────┤
│                         │
│                         │
│       内容区域           │  背景: #F5F7FA
│    (白色卡片组合)        │
│                         │
│                         │
├─────────────────────────┤
│      底部操作栏          │  高度: 50px (如有)
└─────────────────────────┘
```

#### 8.2 首页布局示例

```
┌─────────────────────────┐
│         首页            │
├─────────────────────────┤
│  ┌───────────────────┐  │
│  │  欢迎语 / 医院名称  │  │
│  └───────────────────┘  │
│                         │
│  ┌─────┐ ┌─────┐       │
│  │科室1│ │科室2│  ...   │  科室入口（网格布局）
│  └─────┘ └─────┘       │
│  ┌─────┐ ┌─────┐       │
│  │科室3│ │科室4│  ...   │
│  └─────┘ └─────┘       │
│                         │
│  ┌───────────────────┐  │
│  │    快捷入口卡片     │  │  我的预约、就诊记录
│  └───────────────────┘  │
│                         │
├─────────────────────────┤
│  🏠    📅    👤         │  底部TabBar
│  首页  预约  我的        │
└─────────────────────────┘
```

#### 8.3 列表页规范

```
- 列表项高度: 最小 80rpx
- 列表项左侧图标/头像: 80rpx × 80rpx
- 列表项间距: 使用 1px 分割线
- 列表背景: 白色
- 空状态: 居中显示图标 + 文字提示
```

### 9. 后台管理页面设计规范

#### 9.1 整体布局

```
┌──────────────────────────────────────────────┐
│  Logo    医院预约管理系统         👤 管理员   │  Header: 64px
├─────────┬────────────────────────────────────┤
│         │  面包屑导航                        │
│  侧边栏  ├────────────────────────────────────┤
│         │                                    │
│  · 仪表盘│                                    │
│  · 预约  │           内容区域                 │
│  · 患者  │        (白色背景卡片)              │
│  · 医生  │                                    │
│  · 科室  │                                    │
│  · 排班  │                                    │
│  · 统计  │                                    │
│         │                                    │
└─────────┴────────────────────────────────────┘
  侧边栏: 200px (收起: 64px)
```

#### 9.2 表格页规范

```
┌─────────────────────────────────────────────┐
│  预约管理                          [+ 导出]  │  页面标题 + 操作按钮
├─────────────────────────────────────────────┤
│  [筛选条件]  [状态]  [日期范围]   [🔍 查询]  │  筛选区域
├─────────────────────────────────────────────┤
│  □  预约编号   患者   医生   时间   状态  操作│  表格头
├─────────────────────────────────────────────┤
│  □  AP001     张三   王医生  ...   待诊  查看│
│  □  AP002     李四   刘医生  ...   完成  查看│
│  ...                                        │
├─────────────────────────────────────────────┤
│       共 100 条  <  1  2  3  4  5  >   10条/页│  分页器
└─────────────────────────────────────────────┘
```

#### 9.3 表单页规范

```
表单宽度: 最大 600px，居中或靠左
标签位置: 顶部对齐（推荐）或左侧对齐
必填标识: 红色星号 * 在标签后
错误提示: 输入框下方红色文字
按钮位置: 表单底部，主按钮在左
```

### 10. 图标规范

#### 10.1 图标库选择

```
小程序: uni-icons 或 自定义 iconfont
后台: @ant-design/icons
```

#### 10.2 图标尺寸

| 用途 | 小程序 | 后台 |
|-----|-------|------|
| 导航图标 | 48rpx | 20px |
| 列表图标 | 40rpx | 16px |
| 按钮内图标 | 32rpx | 14px |
| 提示图标 | 28rpx | 12px |

### 11. 动效规范

```scss
// 过渡时长
$transition-fast: 0.15s;     // 快速（hover效果）
$transition-normal: 0.3s;    // 正常（展开收起）
$transition-slow: 0.45s;     // 慢速（页面切换）

// 缓动函数
$ease-in-out: cubic-bezier(0.4, 0, 0.2, 1);
$ease-out: cubic-bezier(0, 0, 0.2, 1);

// 示例
.card {
  transition: box-shadow $transition-fast $ease-in-out;
  &:hover { box-shadow: $shadow-hover; }
}
```

### 12. 设计原则总结

```
✓ 大量留白，呼吸感强
✓ 以白色为主，灰色为辅
✓ 医疗蓝作为点缀色，不过度使用
✓ 避免花哨装饰和渐变
✓ 信息层次清晰，主次分明
✓ 操作反馈及时（loading、成功提示）
✓ 适老化考虑：字号不小于 12px，点击区域不小于 44px
```

## 十一、数据校验规则

### 1. 通用校验规则

#### 1.1 字符串长度限制

| 字段 | 最小长度 | 最大长度 | 说明 |
|-----|---------|---------|------|
| 用户昵称 | 1 | 32 | 支持中英文、数字 |
| 姓名 | 2 | 20 | 中文姓名 |
| 手机号 | 11 | 11 | 固定11位 |
| 身份证号 | 15/18 | 18 | 15或18位 |
| 科室名称 | 2 | 20 | - |
| 医生姓名 | 2 | 20 | - |
| 职称 | 2 | 20 | - |
| 擅长领域 | 0 | 200 | 可为空 |
| 医生简介 | 0 | 1000 | 可为空 |
| 症状描述 | 0 | 500 | 可为空 |
| 诊断结果 | 0 | 2000 | - |
| 处方内容 | 0 | 2000 | - |
| 医嘱 | 0 | 1000 | - |
| 取消原因 | 0 | 200 | - |

#### 1.2 数值范围限制

| 字段 | 最小值 | 最大值 | 说明 |
|-----|-------|-------|------|
| 排序号 | 0 | 9999 | 科室/医生排序 |
| 号源数量 | 1 | 100 | 单时段 |
| 每号时长 | 5 | 60 | 分钟 |
| 分页页码 | 1 | - | 从1开始 |
| 分页大小 | 1 | 100 | 默认10 |

### 2. 格式校验正则

#### 2.1 手机号校验

```go
// Go
var phoneRegex = regexp.MustCompile(`^1[3-9]\d{9}$`)

func ValidatePhone(phone string) bool {
    return phoneRegex.MatchString(phone)
}
```

```typescript
// TypeScript
const phoneRegex = /^1[3-9]\d{9}$/;

export const validatePhone = (phone: string): boolean => {
  return phoneRegex.test(phone);
};
```

#### 2.2 身份证号校验

```go
// Go - 包含校验码验证
func ValidateIDCard(idCard string) bool {
    if len(idCard) != 18 {
        return false
    }

    // 正则基础校验
    pattern := `^\d{17}[\dXx]$`
    matched, _ := regexp.MatchString(pattern, idCard)
    if !matched {
        return false
    }

    // 校验码验证
    weights := []int{7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2}
    checkCodes := "10X98765432"

    sum := 0
    for i := 0; i < 17; i++ {
        num, _ := strconv.Atoi(string(idCard[i]))
        sum += num * weights[i]
    }

    checkCode := checkCodes[sum%11]
    return strings.ToUpper(string(idCard[17])) == string(checkCode)
}
```

```typescript
// TypeScript
export const validateIDCard = (idCard: string): boolean => {
  if (!/^\d{17}[\dXx]$/.test(idCard)) {
    return false;
  }

  const weights = [7, 9, 10, 5, 8, 4, 2, 1, 6, 3, 7, 9, 10, 5, 8, 4, 2];
  const checkCodes = '10X98765432';

  let sum = 0;
  for (let i = 0; i < 17; i++) {
    sum += parseInt(idCard[i]) * weights[i];
  }

  const checkCode = checkCodes[sum % 11];
  return idCard[17].toUpperCase() === checkCode;
};
```

#### 2.3 日期格式校验

```go
// 日期格式: YYYY-MM-DD
var dateRegex = regexp.MustCompile(`^\d{4}-(?:0[1-9]|1[0-2])-(?:0[1-9]|[12]\d|3[01])$`)

// 时间格式: HH:mm
var timeRegex = regexp.MustCompile(`^(?:[01]\d|2[0-3]):[0-5]\d$`)

// 日期时间格式: YYYY-MM-DD HH:mm:ss
var datetimeRegex = regexp.MustCompile(`^\d{4}-(?:0[1-9]|1[0-2])-(?:0[1-9]|[12]\d|3[01]) (?:[01]\d|2[0-3]):[0-5]\d:[0-5]\d$`)
```

### 3. 业务校验规则

#### 3.1 预约创建校验

```go
type CreateAppointmentReq struct {
    PatientID    int64  `json:"patient_id" binding:"required,gt=0"`
    DoctorID     int64  `json:"doctor_id" binding:"required,gt=0"`
    ScheduleID   int64  `json:"schedule_id" binding:"required,gt=0"`
    Date         string `json:"date" binding:"required,datetime=2006-01-02"`
    Symptom      string `json:"symptom" binding:"max=500"`
}

// 业务规则校验
func (r *CreateAppointmentReq) Validate() error {
    // 1. 日期范围校验（明天 ~ 7天后）
    appointmentDate, _ := time.Parse("2006-01-02", r.Date)
    tomorrow := time.Now().AddDate(0, 0, 1).Truncate(24 * time.Hour)
    maxDate := time.Now().AddDate(0, 0, 7).Truncate(24 * time.Hour)

    if appointmentDate.Before(tomorrow) {
        return errors.New("不支持当天预约")
    }
    if appointmentDate.After(maxDate) {
        return errors.New("只能预约7天内的号源")
    }

    return nil
}
```

#### 3.2 就诊人信息校验

```go
type PatientReq struct {
    Name      string `json:"name" binding:"required,min=2,max=20"`
    IDCard    string `json:"id_card" binding:"required,len=18"`
    Phone     string `json:"phone" binding:"required,len=11"`
    Gender    int    `json:"gender" binding:"required,oneof=1 2"`  // 1男 2女
    BirthDate string `json:"birth_date" binding:"required,datetime=2006-01-02"`
    Relation  string `json:"relation" binding:"required,oneof=self parent child spouse other"`
}

// 身份证与出生日期一致性校验
func (r *PatientReq) ValidateConsistency() error {
    // 从身份证提取出生日期
    birthFromID := r.IDCard[6:14]  // YYYYMMDD
    birthDate, _ := time.Parse("2006-01-02", r.BirthDate)
    expectedBirth := birthDate.Format("20060102")

    if birthFromID != expectedBirth {
        return errors.New("出生日期与身份证信息不符")
    }

    // 从身份证提取性别
    genderCode, _ := strconv.Atoi(string(r.IDCard[16]))
    idGender := 1  // 男
    if genderCode%2 == 0 {
        idGender = 2  // 女
    }

    if r.Gender != idGender {
        return errors.New("性别与身份证信息不符")
    }

    return nil
}
```

### 4. 前端校验规则（uni-app）

```typescript
// utils/validate.ts

export const rules = {
  // 手机号
  phone: [
    { required: true, message: '请输入手机号' },
    { pattern: /^1[3-9]\d{9}$/, message: '手机号格式不正确' }
  ],

  // 身份证号
  idCard: [
    { required: true, message: '请输入身份证号' },
    { validator: validateIDCard, message: '身份证号格式不正确' }
  ],

  // 姓名
  name: [
    { required: true, message: '请输入姓名' },
    { min: 2, max: 20, message: '姓名长度为2-20个字符' },
    { pattern: /^[\u4e00-\u9fa5·]+$/, message: '姓名只能包含中文' }
  ],

  // 症状描述
  symptom: [
    { max: 500, message: '症状描述最多500个字符' }
  ]
};
```

### 5. 后端统一校验中间件

```go
// middleware/validator.go
func ValidateRequest() gin.HandlerFunc {
    return func(c *gin.Context) {
        c.Next()

        // 处理校验错误
        if len(c.Errors) > 0 {
            var errors []map[string]string
            for _, e := range c.Errors {
                if ve, ok := e.Err.(validator.ValidationErrors); ok {
                    for _, fe := range ve {
                        errors = append(errors, map[string]string{
                            "field":   fe.Field(),
                            "message": getValidationMessage(fe),
                        })
                    }
                }
            }

            c.JSON(400, gin.H{
                "code":    3099001,
                "message": "参数校验失败",
                "errors":  errors,
            })
            c.Abort()
        }
    }
}

func getValidationMessage(fe validator.FieldError) string {
    switch fe.Tag() {
    case "required":
        return fe.Field() + "不能为空"
    case "min":
        return fe.Field() + "长度不能小于" + fe.Param()
    case "max":
        return fe.Field() + "长度不能大于" + fe.Param()
    case "len":
        return fe.Field() + "长度必须为" + fe.Param()
    default:
        return fe.Field() + "格式不正确"
    }
}
```

## 十二、分页参数规范

### 1. 请求参数格式

```
GET /api/appointments?page=1&page_size=10&status=pending&sort=created_at&order=desc
```

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|-----|------|------|-------|------|
| page | int | 否 | 1 | 页码，从1开始 |
| page_size | int | 否 | 10 | 每页数量，最大100 |
| sort | string | 否 | created_at | 排序字段 |
| order | string | 否 | desc | 排序方向：asc/desc |

### 2. 响应格式

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "list": [
      { "id": 1, "name": "..." },
      { "id": 2, "name": "..." }
    ],
    "pagination": {
      "page": 1,
      "page_size": 10,
      "total": 100,
      "total_pages": 10
    }
  }
}
```

### 3. 分页结构体定义

```go
// Go
type Pagination struct {
    Page       int   `json:"page"`
    PageSize   int   `json:"page_size"`
    Total      int64 `json:"total"`
    TotalPages int   `json:"total_pages"`
}

type PageResponse struct {
    List       interface{} `json:"list"`
    Pagination Pagination  `json:"pagination"`
}

func NewPageResponse(list interface{}, page, pageSize int, total int64) PageResponse {
    totalPages := int(math.Ceil(float64(total) / float64(pageSize)))
    return PageResponse{
        List: list,
        Pagination: Pagination{
            Page:       page,
            PageSize:   pageSize,
            Total:      total,
            TotalPages: totalPages,
        },
    }
}
```

```typescript
// TypeScript
interface Pagination {
  page: number;
  page_size: number;
  total: number;
  total_pages: number;
}

interface PageResponse<T> {
  list: T[];
  pagination: Pagination;
}
```

### 4. 分页查询封装

```go
// repository/base.go
type PageQuery struct {
    Page     int    `form:"page" binding:"min=1"`
    PageSize int    `form:"page_size" binding:"min=1,max=100"`
    Sort     string `form:"sort"`
    Order    string `form:"order" binding:"omitempty,oneof=asc desc"`
}

func (q *PageQuery) GetOffset() int {
    if q.Page < 1 {
        q.Page = 1
    }
    if q.PageSize < 1 {
        q.PageSize = 10
    }
    return (q.Page - 1) * q.PageSize
}

func (q *PageQuery) GetOrderBy(allowedFields []string) string {
    if q.Sort == "" || !contains(allowedFields, q.Sort) {
        q.Sort = "created_at"
    }
    if q.Order == "" {
        q.Order = "desc"
    }
    return q.Sort + " " + q.Order
}
```

### 5. 前端分页组件使用

```typescript
// hooks/usePagination.ts
export function usePagination<T>(
  fetchFn: (params: PageParams) => Promise<PageResponse<T>>
) {
  const [loading, setLoading] = useState(false);
  const [data, setData] = useState<T[]>([]);
  const [pagination, setPagination] = useState({
    page: 1,
    page_size: 10,
    total: 0,
    total_pages: 0,
  });

  const fetch = async (page = 1, pageSize = 10) => {
    setLoading(true);
    try {
      const res = await fetchFn({ page, page_size: pageSize });
      setData(res.list);
      setPagination(res.pagination);
    } finally {
      setLoading(false);
    }
  };

  const onPageChange = (page: number, pageSize: number) => {
    fetch(page, pageSize);
  };

  return { loading, data, pagination, fetch, onPageChange };
}
```

## 十三、数据库索引设计

### 1. 索引设计原则

```
1. 主键自动创建聚簇索引
2. 外键字段必须建立索引
3. 高频查询条件字段建立索引
4. 组合查询使用联合索引（遵循最左前缀原则）
5. 避免在低区分度字段上建立索引（如 status）
6. 定期分析慢查询日志，优化索引
```

### 2. 各表索引定义

#### 2.1 users 表

```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    openid VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- 索引定义
    UNIQUE KEY uk_openid (openid),           -- 微信登录查询
    UNIQUE KEY uk_phone (phone),             -- 手机号唯一
    KEY idx_created_at (created_at)          -- 按时间排序
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 2.2 patients 表

```sql
CREATE TABLE patients (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    name VARCHAR(50) NOT NULL,
    id_card_encrypted VARCHAR(200) NOT NULL,
    id_card_hash VARCHAR(64) NOT NULL,       -- 用于精确查询
    phone_encrypted VARCHAR(200),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- 索引定义
    KEY idx_user_id (user_id),               -- 查询用户的就诊人
    UNIQUE KEY uk_user_idcard (user_id, id_card_hash)  -- 同一用户不重复添加
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 2.3 departments 表

```sql
CREATE TABLE departments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL,
    status TINYINT DEFAULT 1,
    sort_order INT DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    -- 索引定义
    UNIQUE KEY uk_name (name),               -- 科室名唯一
    KEY idx_status_sort (status, sort_order) -- 列表查询
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 2.4 doctors 表

```sql
CREATE TABLE doctors (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    department_id BIGINT NOT NULL,
    name VARCHAR(50) NOT NULL,
    title VARCHAR(50),
    status TINYINT DEFAULT 1,
    sort_order INT DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- 索引定义
    KEY idx_department_id (department_id),                -- 按科室查医生
    KEY idx_dept_status_sort (department_id, status, sort_order)  -- 科室医生列表
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 2.5 schedules 表

```sql
CREATE TABLE schedules (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    doctor_id BIGINT NOT NULL,
    schedule_date DATE NOT NULL,
    period VARCHAR(20) NOT NULL,             -- morning/afternoon
    total_slots INT NOT NULL,
    available_slots INT NOT NULL,
    status TINYINT DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- 索引定义
    UNIQUE KEY uk_doctor_date_period (doctor_id, schedule_date, period),  -- 防重复排班
    KEY idx_date_status (schedule_date, status),         -- 按日期查可预约排班
    KEY idx_doctor_date (doctor_id, schedule_date)       -- 查医生某日排班
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 2.6 appointments 表（核心表，重点优化）

```sql
CREATE TABLE appointments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    appointment_no VARCHAR(32) NOT NULL,
    user_id BIGINT NOT NULL,
    patient_id BIGINT NOT NULL,
    doctor_id BIGINT NOT NULL,
    department_id BIGINT NOT NULL,
    schedule_id BIGINT NOT NULL,
    appointment_date DATE NOT NULL,
    appointment_time TIME NOT NULL,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    symptom VARCHAR(500),
    cancel_reason VARCHAR(200),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- 索引定义
    UNIQUE KEY uk_appointment_no (appointment_no),        -- 预约编号唯一
    KEY idx_user_id (user_id),                           -- 用户预约列表
    KEY idx_patient_date (patient_id, appointment_date), -- 就诊人日期查询
    KEY idx_doctor_date (doctor_id, appointment_date),   -- 医生日期查询
    KEY idx_schedule_id (schedule_id),                   -- 排班关联
    KEY idx_date_status (appointment_date, status),      -- 日期+状态筛选
    KEY idx_user_status (user_id, status),               -- 用户+状态筛选
    KEY idx_created_at (created_at)                      -- 时间排序

    -- 后台管理复合查询索引
    -- KEY idx_dept_date_status (department_id, appointment_date, status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 2.7 medical_records 表

```sql
CREATE TABLE medical_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    appointment_id BIGINT NOT NULL,
    patient_id BIGINT NOT NULL,
    doctor_id BIGINT NOT NULL,
    diagnosis TEXT,
    prescription TEXT,
    advice TEXT,
    visit_date DATE NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    -- 索引定义
    UNIQUE KEY uk_appointment_id (appointment_id),       -- 一次预约一条记录
    KEY idx_patient_id (patient_id),                     -- 患者就诊记录
    KEY idx_patient_date (patient_id, visit_date),       -- 患者按日期查
    KEY idx_doctor_date (doctor_id, visit_date)          -- 医生工作记录
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 2.8 admins 表

```sql
CREATE TABLE admins (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(50) NOT NULL,
    password VARCHAR(100) NOT NULL,
    status TINYINT DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- 索引定义
    UNIQUE KEY uk_username (username)                    -- 用户名唯一
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3. 索引使用建议

#### 3.1 查询优化示例

```sql
-- ✅ 好的查询（命中索引）
SELECT * FROM appointments
WHERE user_id = 123 AND status = 'pending'
ORDER BY created_at DESC;

-- ✅ 好的查询（使用覆盖索引）
SELECT appointment_no, appointment_date, status
FROM appointments
WHERE user_id = 123;

-- ❌ 避免的查询（函数导致索引失效）
SELECT * FROM appointments
WHERE DATE(created_at) = '2024-01-01';

-- ✅ 改写为
SELECT * FROM appointments
WHERE created_at >= '2024-01-01' AND created_at < '2024-01-02';
```

#### 3.2 定期维护

```sql
-- 分析表索引使用情况
ANALYZE TABLE appointments;

-- 查看索引使用统计
SHOW INDEX FROM appointments;

-- 查看慢查询
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 100;
```

## 十四、扩展接口预留

请预留以下接口的扩展能力:

- 在线支付接口
- 电子处方接口
- 检查报告查询接口
- 医生评价接口
- 消息推送接口

## 八、部署说明

请提供:

1. 数据库初始化 SQL 脚本(包含基础数据)
2. 环境变量配置说明(.env.example)
3. 项目启动说明(README.md)
4. 微信小程序配置说明(AppID、服务器域名等)

请开始开发,并确保代码质量和完整性。如有疑问请随时提出。
